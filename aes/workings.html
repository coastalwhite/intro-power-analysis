<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>How AES works - Power analysis Introductory Walkthrough</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../preparing.html"><strong aria-hidden="true">2.</strong> Preparing your environment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../preparing/python-pip.html"><strong aria-hidden="true">2.1.</strong> Python and Pip</a></li><li class="chapter-item expanded "><a href="../preparing/chipwhisperer.html"><strong aria-hidden="true">2.2.</strong> ChipWhisperer</a></li><li class="chapter-item expanded "><a href="../preparing/toolchains.html"><strong aria-hidden="true">2.3.</strong> Compiling your own algorithms</a></li></ol></li><li class="chapter-item expanded "><a href="../rsa.html"><strong aria-hidden="true">3.</strong> Breaking RSA</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../rsa/capture.html"><strong aria-hidden="true">3.1.</strong> Capturing your first trace</a></li><li class="chapter-item expanded "><a href="../rsa/workings.html"><strong aria-hidden="true">3.2.</strong> A deeper look at RSA</a></li><li class="chapter-item expanded "><a href="../rsa/deciphering.html"><strong aria-hidden="true">3.3.</strong> Deciphering a trace</a></li><li class="chapter-item expanded "><a href="../rsa/exercises.html"><strong aria-hidden="true">3.4.</strong> Exercises</a></li></ol></li><li class="chapter-item expanded "><a href="../aes.html"><strong aria-hidden="true">4.</strong> Breaking AES</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../aes/workings.html" class="active"><strong aria-hidden="true">4.1.</strong> How AES works</a></li><li class="chapter-item expanded "><a href="../aes/capture.html"><strong aria-hidden="true">4.2.</strong> Capturing multiple traces</a></li><li class="chapter-item expanded "><a href="../aes/modeling.html"><strong aria-hidden="true">4.3.</strong> Modeling AES</a></li><li class="chapter-item expanded "><a href="../aes/manual-analysis.html"><strong aria-hidden="true">4.4.</strong> Manual analysis</a></li><li class="chapter-item expanded "><a href="../aes/pearson.html"><strong aria-hidden="true">4.5.</strong> Pearson correlation</a></li><li class="chapter-item expanded "><a href="../aes/entire.html"><strong aria-hidden="true">4.6.</strong> Automatically cracking an entire key</a></li><li class="chapter-item expanded "><a href="../aes/optimization.html"><strong aria-hidden="true">4.7.</strong> Sidenote: Optimizing our algorithm</a></li><li class="chapter-item expanded "><a href="../aes/exercises.html"><strong aria-hidden="true">4.8.</strong> Exercises</a></li></ol></li><li class="chapter-item expanded "><a href="../assignment.html"><strong aria-hidden="true">5.</strong> Assignment</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Power analysis Introductory Walkthrough</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/coastalwhite/intro-power-analysis" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="how-aes-works"><a class="header" href="#how-aes-works">How AES Works</a></h1>
<p>In order to do break <em>AES</em> with power analysis, we need a reasonably detailed
understanding of how <em>AES</em> works. So let us do a refresher.</p>
<p>The <em>AES</em> algorithm is a subset of the <strong>Rijndael block cipher</strong> algorithm and
has basically become synonymous with it. As the name <strong>Rijndael block cipher</strong>
implies, we apply the encryption to fixed-size blocks of plain text. With the
size of the blocks being equal to the key size. The encryption is based on
alternating <em>XOR</em> operations and shuffling the bytes of the blocks. Let dive
into each individual component.</p>
<h2 id="the-plan"><a class="header" href="#the-plan">The Plan</a></h2>
<p>As said previously, the <em>AES</em> algorithm works by alternating <em>XOR</em> operations
with the shuffling of the bytes of the blocks. The algorithm specifies that this
is done in rounds. Since <em>AES</em> has 3 different key sizes (128, 192 and 256
bits), each different key size also has a different number of rounds. The amount
of rounds are 10, 12, and 14, respectively.</p>
<p>How does a round look like? Although the first round and the last round have
small differences to the rest we can divide all the rounds up into two sections the
shuffling of bytes and the <em>XOR</em> operation. Let us first have a look at the
<em>XOR</em> operations.</p>
<h2 id="xor-operations"><a class="header" href="#xor-operations">XOR operations</a></h2>
<p>The <em>XOR</em> operation is essentially the adding of the key and is what makes the
running of the <em>AES</em> algorithm different depending on what key is used. Firstly,
in order to make reversal even more different, we <strong>create multiple new keys from
the original key</strong>. This is called the
<a href="https://en.wikipedia.org/wiki/AES_key_schedule">AES key schedule</a>. This
walkthrough will not go into detail on how this key-expansion works, but if
interested one can look up details. The part which is import to this walkthrough
is that after this expansion we have as many new keys as we have rounds. We will
number all the from \(k_0\) to \(k_{10}\) (assuming 128 bit <em>AES</em>).
Here \(k_0\) is the original key and \(k_1\) till \(k_{10}\) are
the expanded keys.</p>
<p><img src="../assets/AES_Key_Schedule.svg" alt="AES Key Schedule" /></p>
<p><em>Figure 1: The AES Key Schedule</em></p>
<p>With these keys we performs a <em>XOR</em> on a block. The <em>XOR</em> operation is a
notorious one way operation. This is due to the lack of information the output
shares about the input. When we do a one bit <em>XOR</em> operation and we receive 1 as
an output, the input could have been (0,1) or (1,0). We also have two options
when we get 0 as output. In the case of one bit, this is not that useful.
However, when we a lot of bits the <em>XOR</em> operator is impossible to instantly
reverse for every output and brute forcing time is equal to trying every option
divided by two. Mathematically this caused by the <em>XOR</em> operation being
non-injective. Furthermore, the other argument is incredibly easy to find when
we have one of the arguments. These two properties make it ideal for a lot of
encryption algorithms.</p>
<p><img src="../assets/XOR_NonInjectivity.svg" alt="XOR Non Injective" /></p>
<p><em>Figure 2: The non injective nature of the XOR operation</em></p>
<h2 id="shuffling-of-bytes"><a class="header" href="#shuffling-of-bytes">Shuffling of bytes</a></h2>
<p>Next let us have a look at the other parts of each round. The shuffling of
the block bytes. Rijndael block ciphers have 3 distinct shuffling techniques:
<strong>substitution, shifting, and mixing</strong>. We are going to have a look at all three
of these shuffling techniques, but let us first have a look at how Rijndael
block ciphers view each block.</p>
<h3 id="block-of-blocks"><a class="header" href="#block-of-blocks">Block-of-blocks?</a></h3>
<p>Rijndael looks at blocks as a matrix of bytes. For the key sizes of key sizes of
128, 192 and 256 bits, we have 4 by 4, 6 by 6 and 8 by 8 matrices, respectively.
This would mean that a 128 bit key with bytes \(b_0, ..., b_{15}\) is turned
into \[
\begin{bmatrix}
b_0 &amp; b_4 &amp; b_8 &amp; b_{12} \\
b_1 &amp; b_5 &amp; b_9 &amp; b_{13} \\
b_2 &amp; b_6 &amp; b_{10} &amp; b_{14} \\
b_3 &amp; b_7 &amp; b_{11} &amp; b_{15}
\end{bmatrix}
\]
Turning a long string of bytes into a matrix allows for matrix operations, which
are common operations for computers. This provides both clarity and speed.</p>
<h3 id="substitution"><a class="header" href="#substitution">Substitution</a></h3>
<p>Now comes one of the most genius but strange parts of the Rijndael block
cipher. This is the substitution box. A substitution block is basically a lookup
table to replace (or substitute) a byte with the one from the lookup table. Some
demands for such a lookup table (when used in encryption algorithms) may be:</p>
<ul>
<li><strong>Reverseable</strong>: In order to find back the original byte, we want to be able
to reverse the process.</li>
<li><strong>Non-Linear</strong>: In order to make resistant to
<a href="https://en.wikipedia.org/wiki/Linear_cryptanalysis">linear</a> and
<a href="https://en.wikipedia.org/wiki/Differential_cryptanalysis">differential</a>
cryptanalysis, the lookup should be very difficult to approximate with a
linear function.</li>
<li><strong>Fixed Output Sizing</strong>: In order to reduce the complexity and loss of excess
data, we want to output to have a fixed bit size (preferably the same as the
input).</li>
</ul>
<p>The <a href="https://en.wikipedia.org/wiki/Rijndael_S-box">Rijndael S-Box</a> does all
these things. Since it has all of these properties, how it specifically looks is
not important. Every implementation of <em>AES</em> can save the Substitution-Box and
its inverse in static memory since it is public knowledge.</p>
<p>Here is the Rijndael S-Box as a python array.</p>
<pre><code class="language-python"># Rijndael Substitution box
SBox = [
    # 0    1    2    3    4    5    6    7    8    9    a    b    c    d    e    f
    0x63,0x7c,0x77,0x7b,0xf2,0x6b,0x6f,0xc5,0x30,0x01,0x67,0x2b,0xfe,0xd7,0xab,0x76, # 0
    0xca,0x82,0xc9,0x7d,0xfa,0x59,0x47,0xf0,0xad,0xd4,0xa2,0xaf,0x9c,0xa4,0x72,0xc0, # 1
    0xb7,0xfd,0x93,0x26,0x36,0x3f,0xf7,0xcc,0x34,0xa5,0xe5,0xf1,0x71,0xd8,0x31,0x15, # 2
    0x04,0xc7,0x23,0xc3,0x18,0x96,0x05,0x9a,0x07,0x12,0x80,0xe2,0xeb,0x27,0xb2,0x75, # 3
    0x09,0x83,0x2c,0x1a,0x1b,0x6e,0x5a,0xa0,0x52,0x3b,0xd6,0xb3,0x29,0xe3,0x2f,0x84, # 4
    0x53,0xd1,0x00,0xed,0x20,0xfc,0xb1,0x5b,0x6a,0xcb,0xbe,0x39,0x4a,0x4c,0x58,0xcf, # 5
    0xd0,0xef,0xaa,0xfb,0x43,0x4d,0x33,0x85,0x45,0xf9,0x02,0x7f,0x50,0x3c,0x9f,0xa8, # 6
    0x51,0xa3,0x40,0x8f,0x92,0x9d,0x38,0xf5,0xbc,0xb6,0xda,0x21,0x10,0xff,0xf3,0xd2, # 7
    0xcd,0x0c,0x13,0xec,0x5f,0x97,0x44,0x17,0xc4,0xa7,0x7e,0x3d,0x64,0x5d,0x19,0x73, # 8
    0x60,0x81,0x4f,0xdc,0x22,0x2a,0x90,0x88,0x46,0xee,0xb8,0x14,0xde,0x5e,0x0b,0xdb, # 9
    0xe0,0x32,0x3a,0x0a,0x49,0x06,0x24,0x5c,0xc2,0xd3,0xac,0x62,0x91,0x95,0xe4,0x79, # a
    0xe7,0xc8,0x37,0x6d,0x8d,0xd5,0x4e,0xa9,0x6c,0x56,0xf4,0xea,0x65,0x7a,0xae,0x08, # b
    0xba,0x78,0x25,0x2e,0x1c,0xa6,0xb4,0xc6,0xe8,0xdd,0x74,0x1f,0x4b,0xbd,0x8b,0x8a, # c
    0x70,0x3e,0xb5,0x66,0x48,0x03,0xf6,0x0e,0x61,0x35,0x57,0xb9,0x86,0xc1,0x1d,0x9e, # d
    0xe1,0xf8,0x98,0x11,0x69,0xd9,0x8e,0x94,0x9b,0x1e,0x87,0xe9,0xce,0x55,0x28,0xdf, # e
    0x8c,0xa1,0x89,0x0d,0xbf,0xe6,0x42,0x68,0x41,0x99,0x2d,0x0f,0xb0,0x54,0xbb,0x16  # f
]
</code></pre>
<h3 id="shifting"><a class="header" href="#shifting">Shifting</a></h3>
<p>The most plain, but equally important, round step is the shifting of the rows.
This step prevents the columns (4 consecutive bytes in the case of the 128 bit
variant) from being <strong>encrypted and decrypted separately</strong>. The step consists of
shifting the first row of the matrix by zero, the second by one, the third by
two and the fourth by three spaces. This looks as follows:</p>
<p><img src="../assets/Shift_Rows.svg" alt="Shift Rows" /></p>
<p><em>Figure 3: Rijndael block cipher's Shift Row</em></p>
<h3 id="mixing"><a class="header" href="#mixing">Mixing</a></h3>
<p>The last shuffling step mixes the columns in order create <a href="https://en.wikipedia.org/wiki/Confusion_and_diffusion">cryptographic
diffusion</a>, which makes
it <strong>resistant to statistical analysis attacks</strong>. The step works by multiplying each
column with the following inversable matrix (multiplication meaning modulo
multiplication and addition meaning <em>XOR</em>): \[
\begin{bmatrix}
2 &amp; 3 &amp; 1 &amp; 1 \\
1 &amp; 2 &amp; 3 &amp; 1 \\
1 &amp; 1 &amp; 2 &amp; 3 \\
3 &amp; 1 &amp; 1 &amp; 2
\end{bmatrix}
\]</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>Let us now provide a overview for how a typical <em>AES</em> encryption looks. One can
imagine that the decryption is just the inverse of these actions we will
therefore gloss over that part.</p>
<p>As said before, the <em>AES</em> encryption process works in rounds. With every round
needing a separate expanded key. Therefore the first step is to create these key
expansions as described in <a href="#xor-operations">XOR Operations</a>. Immediately
following this we that the initial round key \(k_0\) and apply the <em>XOR</em> with
it to each block.</p>
<p>After the summation with the initial round key we will start applying rounds (9,
11 and 13 rounds for key sizes 128, 192 and 256 bits, respectively). These
rounds apply the following order attacks: Firstly, we do a <a href="#substitution">substitution with the
Rijndael S-Box</a>. Secondly, we <a href="#shifting">shift the rows of the
matrix</a>. Thirdly, we <a href="#mixing">mix the columns of the matrix up</a>.
Lastly, we <a href="#xor-operations">add the round key for that round</a>.</p>
<p>If you are counting along, you will notice that the final round is missing. This
is because the final round has a small difference. We <strong>skip the mixing of
columns</strong> step, since it provides nothing in last round.</p>
<p>This all results in the following process:</p>
<ol>
<li><a href="#xor-operations">Key Expansion</a></li>
<li><a href="#xor-operations">Apply \(k_0\) by <em>XOR</em></a></li>
<li>Apply 9, 11, or 13 rounds
<ol>
<li><a href="#substitution">Substitution with the Rijndael S-Box</a></li>
<li><a href="#shifting">Shift the rows</a></li>
<li><a href="#mixing">Mix the columns</a></li>
<li><a href="#xor-operations">Apply \(k_n\) by <em>XOR</em> with \(n\) being the round
number</a></li>
</ol>
</li>
<li>Final round
<ol>
<li><a href="#substitution">Substitution with the Rijndael S-Box</a></li>
<li><a href="#shifting">Shift the rows</a></li>
<li><a href="#xor-operations">Apply \(k_n\) by <em>XOR</em> with \(n\) being the round
number</a></li>
</ol>
</li>
</ol>
<p>After reading this one should have a basic overview and understanding of how
<em>AES</em> works, which you will need for your power analysis. If you want a more
visual explanation, you should watch <a href="https://www.youtube.com/watch?v=O4xNJsjtN6E">AES Explained by
Computerphile</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../aes.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../aes/capture.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../aes.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../aes/capture.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
